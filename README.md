# Календарь издательство "Бичик"

Календарь и виджет на якутском языке по заказу издательства Бичик 2018 г.

![alt text](../media/screenshots/banner.jpg?raw=true)

## Виджеты для iOS и Android

В обоих платформах реалтизованы виджеты, 
где отображаются текущая дата и краткий контент (summary)

<img src="../media/screenshots/widget-ios.png?raw=true" height="400"> <img src="../media/screenshots/widget-android.jpg?raw=true" height="400">

## Поддержка якутского формата даты и времени

Приложение поддерживает только один язык - якутский. 
Якутский не входит в состав `MaterialLocalizations`, поэтому реализована собственная поддержка 
правильных наименований месяцев и дней недели на якутском языке.

Файл с локализацией лежит в [lib/localization_sah.dart](lib/localization_sah.dart).
Подключение к проекту в файле `main.dart` в `MaterialApp.localizationsDelegates`.

## Шрифты

Используются спец шрифты с поддержкой якутских букв:

- SKH_VERDANA.ttf
- SKH_VERDANAB.ttf (bold)

**ВНИМАНИЕ!** Если у вас проблема с отображением текста из папки /assets, 
то установите эти шрифты на ваш компьютер

## Формат хранение контента

<img src="../media/screenshots/screen-3.jpg?raw=true" height="400"> <img src="../media/screenshots/screen-27.jpg?raw=true" height="400"> <img src="../media/screenshots/screen-picker.jpg?raw=true" height="400"> 

В текущей версии, контент статически содержится в папке /assets в виде файлов и директорий по годам, месяца и дням. Один день - один XML файл, весь контент содержится в нем. Дни группированы в папках по месяцам, а месяцы в свою очередь по годам.

_**TO-DO** Контент будет перенесен на удаленный репозиторий. Предварительно на Firebase. Интерфейс репозитория останется неизменным_

**ВНИМАНИЕ!** Поддержка приложения прекращена, по запросу заказчика Издательство "Бичик". Контент имеется только для 2018(только декабрь)-2019 годов.

В приложении используется формат XML(расширенный вариант HTML) для хранения контента.
XML, по сравнению с JSON, более удобен с точки зрения читабельности и редактирования 
большого объема текста.

Автор ввел следующие теги:

- `article` основное тело контента
- `summary` краткое описание, шапка. Также `summary` отображается на виджете главного экрана Android и iOS
- `p` текст с нового абзаца
    - `class` атрибут для оформления текста
- `span` тег для оформления текста внутри тега p
    - `class` атрибут оформления 
- `sun` циклы солнца
    - `ico` иконка всего одна `assets/icon/sun.png`
    - `ris` рассвет
    - `set` закат
    - `com` комментарии
- `moon` циклы луны
    - `ico` иконки находятся в `assets/icon/[1-8].png`
    - `ris`
    - `set`
    - `com`

## Парсер контента

Автор парсит XML, испольуя виджет `Html`, для рекурсивного обхода XML.
Отрисовка происходит полностью кастомно, НЕ используя стандартный рендер `Html`
(т.к. хреново справляется). Вместо `Html`-рендера, используются стандартные компоненты Flutter. 
`Html` используется для обхода DOM-дерева
В зависимости от тега и атрибута, динамически формирется древо из стандартных виджетов.

Кастомный рендер можно посмотреть в файле `main.dart`, в функции getFormattedWidget

## Как устроен хитрая архитектура парсинга?

Есть всего одна переменная хранящее состояние - `DateTime _currentDate`. **Все приложение реагирует на его изменение и рисует себя в зависимости от его значения**. Можно представить эту переменную как модель, а все остальное зависимое от него представление. В `_currentDate` хранится дата текущего дня, который должно быть отобразиться на экране, остальное, весь контент высчитывается и загружается в зависимости от него, т.е. принимают его как аргумент на входе.

Есть всего несколько методов изменяющих `_currentDate`:
- При инициализации. Поведение по умролчанию, тут ставим сегодняшнюю дату `_currentDate = DateTime.now()`
- При нажатии стрелок вправо и влево, `_currentDate` смещается на один день вперед или назад соответственно
- Через `DatePicker`. Диалог выбора дня по календарю. В диалоге выбирается день и присваевается в `_currentDate`

Итак, при изменении `_currentDate` каждый из методов, внутри себя, вызывает процедуру `reloadAssets()`.
Далее `reloadAssets()` берет из репозитория и заполняет следующие внутренние переменные:
- `String article`
- `String summary`
- `String ad`
- `String moon`
- `String sun`

_**TO-DO** тут можно закрыть `_currentDate` в отдельный закрытый класс с интерфейсом управления(влево, вправо, задать напрямую)_

Как мы видим они все обычные строки. Туда заливается XML-контент в виде строки. Из названия понятно их назначение:
- Основной контент (статья, стих, загадка, народная мудрость и т.д.)
- Summary (краткая информация. Чаще всего это знаменательные даты на текущий день)
- Циклы луны и солнца
- Иногда бывает встроенная реклама (`ad`)

Реклама встраивается в виде обычного XML-тега, указывающего на изображение. При нажатии происходит переход на сайт рекламодателя (URL-ссылка находится там-же в параметре XML).

Каждый из этих внутренних переменных (`article`, `summary` и т.д.) содержит данные для своего виджета. 
Эти виджеты расположены на своих постоянных местах, и принимают каждый свою переменную соответственно.

Вы можете увидеть, как они занимают свои места, в свойстве `delegate` виджета `SliverList`, внутри `Scaffold.build`.

Секрет в том что `article`, `summary`, `ad` - это универсальный виджет одного и того же типа. Отличается только входная переменная.
Этот универсальный виджет формируется в методе `getContent(String data)`. Оно на вход принимает XML-строку и парсит его, динамически создавая внутри себя разные композиции, в зависимости от тегов XML. Вы можете легко понять как это происходит, взглянув на тело функций `getContent` и `getFormattedWidget`

Луна и солнце, работает по другому, без динамического парсинга. 
Из репозитори оно выходит уже в готовом виде, в виде DTO-структуры `DayData`. Там уже спарсено и приведено к нужному виду.
Виджет `getSunAndMoon` просто биндит его в себя классическим способом, без изысков.

Виджеты `getDateBar` и `getHeader` зависят только от `_currentDate`, и просто биндят его, также без изысков.

Виджет `getEmptyContent`, рисуется на экране если ни один из: `article`, `summary`, `ad` - не содержит контент (либо у них внутри произошла ошибка)

## GooglePlay и Appstore

В данное время приложение может быть удалено из маркетов,
т.к. автор прекратил поддержку приложения  

[<img src="../media/screenshots/icon-googleplay.png?raw=true" width="200">](https://play.google.com/store/apps/details?id=com.ivanov.tech.yakutcalendar)
[<img src="../media/screenshots/icon-appstore.png?raw=true" width="200">](https://apps.apple.com/us/app/сахалыы-халандаар/id1446178866)

## Share

Приложение дает возможность поделиться контентом. Можно поделиться как основным контентом,
также можно отправить отдельно только summary

